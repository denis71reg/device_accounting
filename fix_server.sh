#!/bin/bash

set -e

echo "๐ง ะัะฟัะฐะฒะปะตะฝะธะต ะฟัะพะฑะปะตะผั ั ัะตัะฒะตัะพะผ Device Accounting..."
echo ""

cd "$(dirname "$0")"

# ะฆะฒะตัะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 1. ะัะพะฒะตัะบะฐ Docker
echo "1๏ธโฃ ะัะพะฒะตัะบะฐ Docker..."
if ! command -v docker &> /dev/null; then
    echo -e "${RED}โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ!${NC}"
    exit 1
fi
echo -e "${GREEN}โ Docker ัััะฐะฝะพะฒะปะตะฝ${NC}"

# 2. ะััะฐะฝะพะฒะบะฐ ะฒัะตั ะบะพะฝัะตะนะฝะตัะพะฒ
echo ""
echo "2๏ธโฃ ะััะฐะฝะพะฒะบะฐ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
echo -e "${GREEN}โ ะะพะฝัะตะนะฝะตัั ะพััะฐะฝะพะฒะปะตะฝั${NC}"

# 3. ะัะพะฒะตัะบะฐ .env
echo ""
echo "3๏ธโฃ ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะธ..."
if [ ! -f .env ]; then
    echo -e "${YELLOW}โ๏ธ  ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ, ัะพะทะดะฐั ะธะท ะฟัะธะผะตัะฐ...${NC}"
    if [ -f env.example ]; then
        cp env.example .env
        echo -e "${YELLOW}โ๏ธ  ะะพะถะฐะปัะนััะฐ, ะพััะตะดะฐะบัะธััะนัะต .env ะธ ัััะฐะฝะพะฒะธัะต SECRET_KEY${NC}"
    else
        echo -e "${RED}โ ะคะฐะนะป env.example ะฝะต ะฝะฐะนะดะตะฝ!${NC}"
        exit 1
    fi
fi
echo -e "${GREEN}โ ะะพะฝัะธะณััะฐัะธั ะฝะฐะนะดะตะฝะฐ${NC}"

# 4. ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน
echo ""
echo "4๏ธโฃ ะกะพะทะดะฐะฝะธะต ะฝะตะพะฑัะพะดะธะผัั ะดะธัะตะบัะพัะธะน..."
mkdir -p instance logs
chmod 755 instance
chmod 755 logs
echo -e "${GREEN}โ ะะธัะตะบัะพัะธะธ ัะพะทะดะฐะฝั${NC}"

# 5. ะะตัะตัะฑะพัะบะฐ ะพะฑัะฐะทะฐ
echo ""
echo "5๏ธโฃ ะะตัะตัะฑะพัะบะฐ Docker ะพะฑัะฐะทะฐ..."
docker-compose -f docker-compose.prod.yml build --no-cache
echo -e "${GREEN}โ ะะฑัะฐะท ะฟะตัะตัะพะฑัะฐะฝ${NC}"

# 6. ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ
echo ""
echo "6๏ธโฃ ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose -f docker-compose.prod.yml up -d
echo -e "${GREEN}โ ะะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั${NC}"

# 7. ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ
echo ""
echo "7๏ธโฃ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั (15 ัะตะบัะฝะด)..."
sleep 15

# 8. ะัะพะฒะตัะบะฐ ััะฐัััะฐ
echo ""
echo "8๏ธโฃ ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะบะพะฝัะตะนะฝะตัะพะฒ..."
if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
    echo -e "${GREEN}โ ะะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั${NC}"
    docker-compose -f docker-compose.prod.yml ps
else
    echo -e "${RED}โ ะะพะฝัะตะนะฝะตัั ะฝะต ะทะฐะฟััะตะฝั!${NC}"
    echo ""
    echo "ะะพะณะธ ะฟะพัะปะตะดะฝะธั ะพัะธะฑะพะบ:"
    docker-compose -f docker-compose.prod.yml logs app --tail=50
    exit 1
fi

# 9. ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน
echo ""
echo "9๏ธโฃ ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน ะฑะฐะทั ะดะฐะฝะฝัั..."
if docker-compose -f docker-compose.prod.yml exec -T app flask db upgrade 2>/dev/null; then
    echo -e "${GREEN}โ ะะธะณัะฐัะธะธ ะฟัะธะผะตะฝะตะฝั${NC}"
else
    echo -e "${YELLOW}โ๏ธ  ะัะธะฑะบะฐ ะฟัะธ ะฟัะธะผะตะฝะตะฝะธะธ ะผะธะณัะฐัะธะน (ะฒะพะทะผะพะถะฝะพ, ัะถะต ะฟัะธะผะตะฝะตะฝั)${NC}"
fi

# 10. ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ
echo ""
echo "๐ ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ะฟัะธะปะพะถะตะฝะธั..."
sleep 5

if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:5001 | grep -q "200\|302\|301"; then
    echo -e "${GREEN}โ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฝะฐ http://127.0.0.1:5001${NC}"
else
    echo -e "${YELLOW}โ๏ธ  ะัะธะปะพะถะตะฝะธะต ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ http://127.0.0.1:5001${NC}"
    echo ""
    echo "ะะพัะปะตะดะฝะธะต ะปะพะณะธ:"
    docker-compose -f docker-compose.prod.yml logs app --tail=30
fi

# 11. ะัะพะณะพะฒะฐั ะธะฝัะพัะผะฐัะธั
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${GREEN}โ ะัะพัะตัั ะทะฐะฒะตััะตะฝ!${NC}"
echo ""
echo "ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:"
echo "  โข ะัะพัะผะพัั ะปะพะณะพะฒ: docker-compose -f docker-compose.prod.yml logs -f app"
echo "  โข ะกัะฐััั: docker-compose -f docker-compose.prod.yml ps"
echo "  โข ะััะฐะฝะพะฒะบะฐ: docker-compose -f docker-compose.prod.yml down"
echo "  โข ะะตัะตะทะฐะฟััะบ: docker-compose -f docker-compose.prod.yml restart"
echo ""
echo "ะัะธะปะพะถะตะฝะธะต ะดะพะปะถะฝะพ ะฑััั ะดะพัััะฟะฝะพ ะฝะฐ:"
echo "  โข http://127.0.0.1:5001 (ะฝะฐะฟััะผัั)"
echo "  โข http://127.0.0.1:2022 (ัะตัะตะท Nginx, ะตัะปะธ ะฝะฐัััะพะตะฝ)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"




