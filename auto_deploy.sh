#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./auto_deploy.sh

set -e

SERVER="ittest@192.168.16.44"
REMOTE_PATH="/opt/device_accounting"

echo "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π Device Accounting..."
echo "–°–µ—Ä–≤–µ—Ä: $SERVER"
echo "–ü—É—Ç—å: $REMOTE_PATH"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –¥–æ—Å—Ç—É–ø–∞
echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –¥–æ—Å—Ç—É–ø–∞..."
if ! ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no "$SERVER" "echo 'SSH OK'" 2>/dev/null; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É!"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "  1. –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (192.168.16.44)"
    echo "  2. –¢—Ä–µ–±—É–µ—Ç—Å—è VPN –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
    echo "  3. SSH –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    echo ""
    echo "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:"
    echo "  1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ deploy_package.tar.gz –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤—Ä—É—á–Ω—É—é"
    echo "  2. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "     cd $REMOTE_PATH"
    echo "     tar -xzf deploy_package.tar.gz"
    echo "     ./deploy_remote.sh"
    exit 1
fi

echo "‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
echo ""

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
rsync -avz --progress \
    --exclude '.git' \
    --exclude 'venv' \
    --exclude '__pycache__' \
    --exclude '*.pyc' \
    --exclude 'instance' \
    --exclude '.env' \
    --exclude '*.db' \
    --exclude '*.log' \
    --exclude '.DS_Store' \
    --exclude 'deploy_package.tar.gz' \
    ./ "$SERVER:$REMOTE_PATH/"

echo "‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
echo ""

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh "$SERVER" << 'ENDSSH'
    cd /opt/device_accounting
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ .env
    if [ ! -f .env ]; then
        echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é –∏–∑ –ø—Ä–∏–º–µ—Ä–∞..."
        if [ -f env.example ]; then
            cp env.example .env
            echo "‚úèÔ∏è  –í–ê–ñ–ù–û: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SECRET_KEY!"
            exit 1
        fi
    fi
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    mkdir -p instance logs
    chmod 755 instance
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    docker-compose -f docker-compose.prod.yml down || true
    
    # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
    echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
    docker-compose -f docker-compose.prod.yml build
    
    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    docker-compose -f docker-compose.prod.yml up -d
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    sleep 5
    
    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
    echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    docker-compose -f docker-compose.prod.yml exec -T app flask db upgrade || echo "‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
    docker-compose -f docker-compose.prod.yml ps
    
    echo ""
    echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
    echo "üìù –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: https://da.dev-ittest.ru"
ENDSSH

echo ""
echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"




