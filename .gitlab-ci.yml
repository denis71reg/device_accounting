stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  APP_NAME: device_accounting
  DEPLOY_PATH: /opt/device_accounting
  SERVER_HOST: 91.193.239.177
  SERVER_PORT: "2022"
  SERVER_USER: ittest

# –ö—ç—à –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python
cache:
  paths:
    - venv/

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test:
  stage: test
  image: python:3.12-slim
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-cov pytest-flask
  script:
    - source venv/bin/activate
    - export FLASK_APP=da.app
    - export FLASK_ENV=testing
    - pytest -v --tb=short --cov=da --cov-report=term-missing || true
  only:
    - main
    - develop
    - merge_requests

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
deploy:
  stage: deploy
  image: alpine:latest
  variables:
    SERVER_HOST: "91.193.239.177"
    SERVER_PORT: "2022"
    SERVER_USER: "ittest"
    DEPLOY_PATH: "/opt/device_accounting"
  before_script:
    - apk add --no-cache openssh-client rsync git
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p $SERVER_PORT -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ $SERVER_USER@$SERVER_HOST:$SERVER_PORT ‚Üí $DEPLOY_PATH"
      ssh -p $SERVER_PORT -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $SERVER_USER@$SERVER_HOST bash << 'ENDSSH'
        set -e
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
        
        # –ï—Å–ª–∏ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ –Ω–µ–π –µ—Å—Ç—å .git ‚Äî –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
        if [ -d "$DEPLOY_PATH/.git" ]; then
          echo "‚úÖ –ù–∞–π–¥–µ–Ω Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ $DEPLOY_PATH"
          cd $DEPLOY_PATH
          
          echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
          # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          git checkout .
          
          if git fetch origin; then
             git reset --hard origin/main 2>/dev/null || git reset --hard origin/master
          else
             echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ fetch. –ü–æ–ø—Ä–æ–±—É—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
             cd ..
             rm -rf "$DEPLOY_PATH"
          fi
        fi
        
        # –ï—Å–ª–∏ –ø–∞–ø–∫–∏ –Ω–µ—Ç (–∏–ª–∏ –º—ã –µ—ë —Ç–æ–ª—å–∫–æ —á—Ç–æ —É–¥–∞–ª–∏–ª–∏) ‚Äî –∫–ª–æ–Ω–∏—Ä—É–µ–º
        if [ ! -d "$DEPLOY_PATH" ]; then
           echo "‚ö†Ô∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ö–ª–æ–Ω–∏—Ä—É—é –∑–∞–Ω–æ–≤–æ..."
           # –£–¥–∞–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –º—É—Å–æ—Ä (–ø–∞–ø–∫–∞ –±–µ–∑ .git)
           rm -rf "$DEPLOY_PATH"
           
           mkdir -p /opt
           cd /opt
           git clone https://code.dev-ittest.ru/ittest/device-accounting/da-python.git device_accounting
           cd device_accounting
        fi
        
        # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤–Ω—É—Ç—Ä–∏
        cd $DEPLOY_PATH
        
        echo "üî® –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml down || true
        
        echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml build
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml up -d
        
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (15 —Å–µ–∫—É–Ω–¥)..."
        sleep 15
        
        echo "üìä –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
        docker-compose -f docker-compose.prod.yml exec -T app flask db upgrade || echo "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞"
        
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml ps
        
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ: https://da.dev-ittest.ru"
      ENDSSH
  only:
    - main
    - master
  when: on_success
  environment:
    name: production
    url: https://da.dev-ittest.ru

