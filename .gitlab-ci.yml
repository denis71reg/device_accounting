stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  APP_NAME: device_accounting
  DEPLOY_PATH: /opt/device_accounting
  SERVER_HOST: 91.193.239.177
  SERVER_PORT: "2022"
  SERVER_USER: ittest

# –ö—ç—à –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python
cache:
  paths:
    - venv/

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test:
  stage: test
  image: python:3.12-slim
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-cov pytest-flask
  script:
    - source venv/bin/activate
    - export FLASK_APP=da.app
    - export FLASK_ENV=testing
    - pytest -v --tb=short --cov=da --cov-report=term-missing || true
  only:
    - main
    - develop
    - merge_requests

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
deploy:
  stage: deploy
  image: alpine:latest
  variables:
    SERVER_HOST: "91.193.239.177"
    SERVER_PORT: "2022"
    SERVER_USER: "ittest"
    DEPLOY_PATH: "/opt/device_accounting"
  before_script:
    - apk add --no-cache openssh-client rsync git
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p $SERVER_PORT -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ $SERVER_USER@$SERVER_HOST:$SERVER_PORT ‚Üí $DEPLOY_PATH"
      ssh -p $SERVER_PORT -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $SERVER_USER@$SERVER_HOST bash << 'ENDSSH'
        set -e
        echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
        cd $DEPLOY_PATH 2>/dev/null || {
          echo "üì• –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∫–ª–æ–Ω–∏—Ä—É—é..."
          mkdir -p /opt
          cd /opt
          git clone https://code.dev-ittest.ru/ittest/device-accounting/da-python.git device_accounting
          cd device_accounting
        }
        
        echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitLab..."
        git fetch origin
        git reset --hard origin/main 2>/dev/null || git reset --hard origin/master
        
        echo "üî® –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml down || true
        
        echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml build
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml up -d
        
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (15 —Å–µ–∫—É–Ω–¥)..."
        sleep 15
        
        echo "üìä –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
        docker-compose -f docker-compose.prod.yml exec -T app flask db upgrade || echo "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞"
        
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml ps
        
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ: https://da.dev-ittest.ru"
      ENDSSH
  only:
    - main
    - master
  when: on_success
  environment:
    name: production
    url: https://da.dev-ittest.ru

