stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  APP_NAME: device_accounting
  DEPLOY_PATH: /opt/device_accounting
  SERVER_HOST: 91.193.239.177
  SERVER_PORT: "2022"
  SERVER_USER: ittest

# –ö—ç—à –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python
cache:
  paths:
    - venv/

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test:
  stage: test
  image: python:3.12-slim
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-cov pytest-flask
  script:
    - source venv/bin/activate
    - export FLASK_APP=da.app
    - export FLASK_ENV=testing
    - pytest -v --tb=short --cov=da --cov-report=term-missing || true
  only:
    - main
    - develop
    - merge_requests

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
deploy:
  stage: deploy
  image: alpine:latest
  variables:
    SERVER_HOST: "91.193.239.177"
    SERVER_PORT: "2022"
    SERVER_USER: "ittest"
    DEPLOY_PATH: "/opt/device_accounting"
  before_script:
    - apk add --no-cache openssh-client rsync git
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p $SERVER_PORT -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ $SERVER_USER@$SERVER_HOST:$SERVER_PORT ‚Üí $DEPLOY_PATH"
      ssh -p $SERVER_PORT -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $SERVER_USER@$SERVER_HOST bash << 'ENDSSH'
        set -e
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
        
        # –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        if [ -d "$DEPLOY_PATH/.git" ]; then
          echo "‚úÖ –ù–∞–π–¥–µ–Ω Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ $DEPLOY_PATH"
          cd $DEPLOY_PATH
          
          echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
          git checkout . || true
          
          if git fetch origin; then
             git reset --hard origin/main 2>/dev/null || git reset --hard origin/master
          else
             echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ fetch. –ü–æ–º–µ—á–∞—é –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ..."
             cd ..
             # –ò—Å–ø–æ–ª—å–∑—É–µ–º sudo, –µ—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
             sudo rm -rf "$DEPLOY_PATH" || rm -rf "$DEPLOY_PATH"
          fi
        elif [ -d "$DEPLOY_PATH" ]; then
           # –ü–∞–ø–∫–∞ –µ—Å—Ç—å, –Ω–æ .git –Ω–µ—Ç ‚Äî —É–¥–∞–ª—è–µ–º
           echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º. –£–¥–∞–ª—è—é..."
           sudo rm -rf "$DEPLOY_PATH" || rm -rf "$DEPLOY_PATH"
        fi
        
        # –ï—Å–ª–∏ –ø–∞–ø–∫–∏ –Ω–µ—Ç (–∏–ª–∏ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞) ‚Äî –∫–ª–æ–Ω–∏—Ä—É–µ–º
        if [ ! -d "$DEPLOY_PATH" ]; then
           echo "üì• –ö–ª–æ–Ω–∏—Ä—É—é –ø—Ä–æ–µ–∫—Ç –∑–∞–Ω–æ–≤–æ..."
           
           # –°–æ–∑–¥–∞–µ–º /opt –µ—Å–ª–∏ –Ω–µ—Ç (–Ω—É–∂–µ–Ω sudo –µ—Å–ª–∏ /opt —Å–∏—Å—Ç–µ–º–Ω—ã–π)
           sudo mkdir -p /opt || mkdir -p /opt
           
           # –í—ã–¥–∞–µ–º –ø—Ä–∞–≤–∞ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ /opt/device_accounting (—á—Ç–æ–±—ã git clone —Å—Ä–∞–±–æ—Ç–∞–ª)
           sudo chown -R $USER /opt || true
           
           cd /opt
           git clone https://code.dev-ittest.ru/ittest/device-accounting/da-python.git device_accounting
           cd device_accounting
        fi
        
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º—ã –≤ –Ω—É–∂–Ω–æ–π –ø–∞–ø–∫–µ
        cd $DEPLOY_PATH
        
        echo "üî® –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml down || true
        
        echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml build
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml up -d
        
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (15 —Å–µ–∫—É–Ω–¥)..."
        sleep 15
        
        echo "üìä –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
        docker-compose -f docker-compose.prod.yml exec -T app flask db upgrade || echo "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞"
        
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker-compose -f docker-compose.prod.yml ps
        
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ: https://da.dev-ittest.ru"
      ENDSSH
  only:
    - main
    - master
  when: on_success
  environment:
    name: production
    url: https://da.dev-ittest.ru

