#!/bin/bash
# –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ù–ê –°–ï–†–í–ï–†–ï –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

set -e

echo "üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Device Accounting –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo ""

cd /opt/device_accounting

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env
if [ ! -f .env ]; then
    echo "‚ö†Ô∏è  .env –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é –∏–∑ –ø—Ä–∏–º–µ—Ä–∞..."
    [ -f env.example ] && cp env.example .env
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose -f docker-compose.prod.yml down || true

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ë–ï–ó –∫—ç—à–∞
echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ (–±–µ–∑ –∫—ç—à–∞)..."
docker-compose -f docker-compose.prod.yml build --no-cache

# –ó–∞–ø—É—Å–∫
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
docker-compose -f docker-compose.prod.yml up -d

# –û–∂–∏–¥–∞–Ω–∏–µ
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞..."
sleep 5

# –ú–∏–≥—Ä–∞—Ü–∏–∏
echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
docker-compose -f docker-compose.prod.yml exec -T app flask db upgrade || echo "‚ö†Ô∏è  –ú–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

# –°—Ç–∞—Ç—É—Å
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
docker-compose -f docker-compose.prod.yml ps

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: https://da.dev-ittest.ru"
echo "   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: '–î–µ–≤–∞–π—Å—ã' –≤–º–µ—Å—Ç–æ '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å'"
echo "   –ö–Ω–æ–ø–∫–∏ '–í—ã–¥–∞—Ç—å' –∏ '–í–µ—Ä–Ω—É—Ç—å' –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã"




